<!DOCTYPE html>
<html>
<head>
    <title>病案管理</title>
    {% include 'system/common/header.html' %}
</head>
<body class="pear-container">
<div class="layui-card">
    <div class="layui-card-body">
        <form class="layui-form" lay-filter="records-query-form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">病案编号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="RecordNumber" placeholder="请输入病案编号" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">诊断</label>
                    <div class="layui-input-inline">
                        <input type="text" name="Diagnosis" placeholder="请输入诊断信息" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">关联患者</label>
                    <div class="layui-input-inline">
                        <select name="PatientID" lay-search>
                            <option value="">全部</option>
                            {% for patient in patients %}
                                <option value="{{ patient.PatientID }}">{{ patient.PatientNo }} - {{ patient.Name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="records-query">
                        <i class="layui-icon layui-icon-search"></i>查询
                    </button>
                    <button type="reset" class="pear-btn pear-btn-md">
                        <i class="layui-icon layui-icon-refresh"></i>重置
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="layui-card">
    <div class="layui-card-body">
        <table id="records-table" lay-filter="records-table"></table>
    </div>
</div>

<script type="text/html" id="records-toolbar">
    {% if authorize("system:records:add") %}
    <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add">
        <i class="pear-icon pear-icon-add"></i>新增
    </button>
    {% endif %}
</script>

<script type="text/html" id="records-bar">
    {% if authorize("system:records:edit") %}
    <button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="edit">
        <i class="pear-icon pear-icon-edit"></i>编辑
    </button>
    {% endif %}
    {% if authorize("system:records:remove") %}
    <button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="remove">
        <i class="pear-icon pear-icon-ashbin"></i>删除
    </button>
    {% endif %}
</script>

{% include 'system/common/footer.html' %}
<script>
layui.use(['table','form','jquery','popup'], function () {
    let table = layui.table
    let form = layui.form
    let $ = layui.jquery
    let popup = layui.popup
    let MODULE_PATH = "{{ url_for('system.records.main') }}"

    table.render({
        elem: '#records-table',
        url: MODULE_PATH + 'data',
        page: true,
        skin: 'line',
        toolbar: '#records-toolbar',
        height: 'full-160',
        defaultToolbar: [{layEvent: 'refresh', icon: 'layui-icon-refresh'}, 'filter', 'print', 'exports'],
        cols: [[
            {title: '病案编号', field: 'RecordNumber', align: 'center'},
            {title: '患者姓名', field: 'PatientName', align: 'center'},
            {title: '初诊时间', field: 'RecordTime', align: 'center', width: 160},
            {title: '诊断', field: 'Diagnosis', align: 'center'},
            {title: '他院诊断', field: 'OtherDiagnosis', align: 'center'},
            {title: '病理', field: 'Pathology', align: 'center'},
            {title: '备注', field: 'Remarks', align: 'center'},
            {title: '操作', toolbar: '#records-bar', align: 'center', width: 180}
        ]]
    })

    form.on('submit(records-query)', function (data) {
        table.reload('records-table', {where: data.field})
        return false
    })

    table.on('tool(records-table)', function (obj) {
        if (obj.event === 'edit') {
            window.edit(obj)
        } else if (obj.event === 'remove') {
            window.remove(obj)
        }
    })

    table.on('toolbar(records-table)', function (obj) {
        if (obj.event === 'add') {
            window.add()
        } else if (obj.event === 'refresh') {
            table.reload('records-table')
        }
    })

    window.add = function () {
        layer.open({
            type: 2,
            title: '新增病案',
            shade: 0.1,
            area: ['700px', '620px'],
            content: MODULE_PATH + 'add'
        })
    }

    window.edit = function (obj) {
        layer.open({
            type: 2,
            title: '编辑病案',
            shade: 0.1,
            area: ['700px', '620px'],
            content: MODULE_PATH + 'edit/' + obj.data['RecordID']
        })
    }

    window.remove = function (obj) {
        layer.confirm('确定要删除该病案记录吗？', {icon: 3, title: '提示'}, function (index) {
            layer.close(index)
            let loading = layer.load()
            $.ajax({
                url: MODULE_PATH + 'remove/' + obj.data['RecordID'],
                type: 'delete',
                success: function (result) {
                    layer.close(loading)
                    if (result.success) {
                        popup.success(result.msg, function () {
                            obj.del()
                        })
                    } else {
                        popup.failure(result.msg)
                    }
                }
            })
        })
    }
})
</script>
</body>
</html>
