<!DOCTYPE html>
<html>
<head>
    <title>诊断管理</title>
    {% include 'system/common/header.html' %}
</head>
<body class="pear-container">
<div class="layui-card">
    <div class="layui-card-body">
        <form class="layui-form" lay-filter="diagnostic-query-form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">诊断</label>
                    <div class="layui-input-inline">
                        <input type="text" name="Diagnosis" placeholder="请输入诊断关键词" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">病理</label>
                    <div class="layui-input-inline">
                        <input type="text" name="Pathology" placeholder="请输入病理关键词" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">关联患者</label>
                    <div class="layui-input-inline">
                        <select name="PatientID" lay-search>
                            <option value="">全部</option>
                            {% for patient in patients %}
                                <option value="{{ patient.PatientID }}">{{ patient.PatientNo }} - {{ patient.Name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="diagnostic-query">
                        <i class="layui-icon layui-icon-search"></i>查询
                    </button>
                    <button type="reset" class="pear-btn pear-btn-md">
                        <i class="layui-icon layui-icon-refresh"></i>重置
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="layui-card">
    <div class="layui-card-body">
        <table id="diagnostic-table" lay-filter="diagnostic-table"></table>
    </div>
</div>

<script type="text/html" id="diagnostic-toolbar">
    {% if authorize("system:diagnostic:add") %}
    <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add">
        <i class="pear-icon pear-icon-add"></i>新增
    </button>
    {% endif %}
</script>

<script type="text/html" id="diagnostic-bar">
    {% if authorize("system:diagnostic:edit") %}
    <button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="edit">
        <i class="pear-icon pear-icon-edit"></i>编辑
    </button>
    {% endif %}
    {% if authorize("system:diagnostic:remove") %}
    <button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="remove">
        <i class="pear-icon pear-icon-ashbin"></i>删除
    </button>
    {% endif %}
</script>

{% include 'system/common/footer.html' %}
<script>
layui.use(['table','form','jquery','popup'], function () {
    let table = layui.table
    let form = layui.form
    let $ = layui.jquery
    let popup = layui.popup
    let MODULE_PATH = "{{ url_for('system.diagnostic.main') }}"

    table.render({
        elem: '#diagnostic-table',
        url: MODULE_PATH + 'data',
        page: true,
        skin: 'line',
        height: 'full-148',
        toolbar: '#diagnostic-toolbar',
        defaultToolbar: [{layEvent: 'refresh', icon: 'layui-icon-refresh'}, 'filter', 'print', 'exports'],
        cols: [[
            {title: '患者姓名', field: 'PatientName', align: 'center', width: 120},
            {title: '患者编号', field: 'PatientNo', align: 'center', width: 120},
            {title: '诊断', field: 'DiagnosisList', align: 'center', width: 250, templet: function(d) {
                if (d.DiagnosisList && d.DiagnosisList.length > 0) {
                    return d.DiagnosisList.map(function(tag) {
                        return '<span style="display: inline-block; padding: 2px 8px; background: #5FB878; color: #fff; border-radius: 3px; margin-right: 5px; font-size: 12px;">' + tag + '</span>';
                    }).join('');
                }
                return '<span style="color: #999;">暂无</span>';
            }},
            {title: '病理', field: 'Pathology', align: 'center', width: 250, templet: function(d) {
                return d.Pathology ? (d.Pathology.length > 50 ? d.Pathology.substring(0, 50) + '...' : d.Pathology) : '<span style="color: #999;">暂无</span>';
            }},
            {title: '附件', field: 'AttachmentsList', align: 'center', width: 100, templet: function(d) {
                if (d.AttachmentsList && d.AttachmentsList.length > 0) {
                    return '<span style="color: #5FB878;">' + d.AttachmentsList.length + ' 张</span>';
                }
                return '<span style="color: #999;">无</span>';
            }},
            {title: '备注', field: 'Remarks', align: 'center', width: 250, templet: function(d) {
                return d.Remarks ? (d.Remarks.length > 30 ? d.Remarks.substring(0, 30) + '...' : d.Remarks) : '<span style="color: #999;">暂无</span>';
            }},
            {title: '创建时间', field: 'CreateDate', align: 'center', width: 180},
            {title: '操作', toolbar: '#diagnostic-bar', align: 'center', width: 260}
        ]]
    })

    form.on('submit(diagnostic-query)', function (data) {
        table.reload('diagnostic-table', {where: data.field})
        return false
    })

    table.on('tool(diagnostic-table)', function (obj) {
        if (obj.event === 'edit') {
            window.edit(obj)
        } else if (obj.event === 'remove') {
            window.remove(obj)
        }
    })

    table.on('toolbar(diagnostic-table)', function (obj) {
        if (obj.event === 'add') {
            window.add()
        } else if (obj.event === 'refresh') {
            table.reload('diagnostic-table')
        }
    })

    window.add = function () {
        layer.open({
            type: 2,
            title: '新增诊断信息',
            shade: 0.1,
            area: ['700px', '650px'],
            content: MODULE_PATH + 'add'
        })
    }

    window.edit = function (obj) {
        layer.open({
            type: 2,
            title: '编辑诊断信息',
            shade: 0.1,
            area: ['700px', '650px'],
            content: MODULE_PATH + 'edit/' + obj.data['DiagnosticID']
        })
    }

    window.remove = function (obj) {
        layer.confirm('确定要删除该诊断记录吗？', {icon: 3, title: '提示'}, function (index) {
            layer.close(index)
            let loading = layer.load()
            $.ajax({
                url: MODULE_PATH + 'remove/' + obj.data['DiagnosticID'],
                type: 'delete',
                success: function (result) {
                    layer.close(loading)
                    if (result.success) {
                        popup.success(result.msg, function () {
                            obj.del()
                        })
                    } else {
                        popup.failure(result.msg)
                    }
                }
            })
        })
    }
})
</script>
</body>
</html>