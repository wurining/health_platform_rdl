<!DOCTYPE html>
<html lang="en">
<head>
    <title>患者详情</title>
    {% include 'system/common/header.html' %}
    <style>
        .detail-container {padding: 10px;}
        .patient-info-section {background: #f8f9fa;padding: 10px;margin-bottom: 20px;border-radius: 4px;}
        .patient-info-item {display: inline-block;margin-right: 30px;margin-bottom: 10px;}
        .patient-info-label {font-weight: bold;color: #666;}
        .collapse-section {margin-bottom: 15px;}
        .section-header {display: flex;justify-content: space-between;align-items: center;padding: 10px 0;}
        .list-item {padding: 10px;border-bottom: 1px solid #eee;position: relative;}
        .list-item:hover {background: #f5f5f5;}
        .item-actions {position: absolute;right: 15px;top: 15px;}
        .empty-tip {text-align: center;padding: 30px;color: #999;}
        .diagnosis-tags {display: flex;flex-wrap: wrap;gap: 8px;}
        .diagnosis-tag {display: inline-block;padding: 5px 12px;background: #5FB878;color: #fff;border-radius: 3px;position: relative;padding-right: 25px;}
        .diagnosis-tag .tag-close {position: absolute;right: 5px;cursor: pointer;font-size: 14px;}
        .diagnosis-tag .tag-close:hover {color: #ff5722;}
        .attachments-preview {display: flex;flex-wrap: wrap;gap: 10px;}
        .attachment-item {position: relative;width: 80px;height: 80px;border: 1px solid #ddd;border-radius: 4px;overflow: hidden;}
        .attachment-item img {width: 100%;height: 100%;object-fit: cover;cursor: pointer;}
        .attachment-item .delete-btn {position: absolute;top: 2px;right: 2px;background: rgba(0,0,0,0.6);color: #fff;border: none;border-radius: 50%;width: 20px;height: 20px;line-height: 20px;text-align: center;cursor: pointer;font-size: 12px;}
        .attachment-item .delete-btn:hover {background: rgba(255,0,0,0.8);}
    </style>
</head>
<body>
    <div class="pear-container">
        <div class="layui-panel">
            <div class="layui-row" style="padding: 20px;">
                <span class="layui-col-xs2"><strong>患者：</strong>{{ patient.Name or '' }} </span>
                <span class="layui-col-xs2"><strong>编号：</strong>{{ patient.PatientNo or '' }} </span>
                <span class="layui-col-xs1"><strong>性别：</strong>{{ patient.Sex or '-' }} </span>
                <span class="layui-col-xs2"><strong>年纪：</strong>{{ patient.Age or '-' }} </span>
                <span class="layui-col-xs3"><strong>日期：</strong>{{ patient.CreateDate or '' }} </span>
                <span class="layui-col-xs2">
                    <button class="pear-btn pear-btn-primary pear-btn-sm" id="refresh-btn" onclick="window.location.reload()"><i class="pear-icon pear-icon-refresh"></i> 刷新 </button>      
                    <button class="pear-btn pear-btn-primary pear-btn-sm" id="collapse-all-btn"><i class="pear-icon pear-icon-up"></i> 收缩所有 </button>      
                </span>
            </div>
        </div>
    </div>

    <!-- 患者基本信息 -->
    <div class="layui-collapse" lay-filter="filter-collapse">
        <!-- 患者基本信息 -->
        <div class="layui-colla-item">
          <div class="layui-colla-title" style="background: #1e9fff; color: #fff;"><b>患者基本信息</b></div>
          <div class="layui-colla-content colls-show layui-show">
            <form class="layui-form" style="padding: 10px;">
                <div class="layui-form-item layui-hide">
                    <label class="layui-form-label">PatientID</label>
                    <div class="layui-input-block">
                        <input type="text" value="{{ patient.PatientID }}" name="PatientID" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">编号</label>
                    <div class="layui-input-block">
                        <input type="text" value="{{ patient.PatientNo }}" name="PatientNo" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">患者姓名</label>
                    <div class="layui-input-block">
                        <input type="text" name="Name" value="{{ patient.Name }}" lay-verify="title" autocomplete="off" placeholder="请输入患者姓名" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">性别</label>
                    <div class="layui-input-block layui-form">
                        <input type="radio" name="Sex" value="男" title="男" {% if patient.Sex == '男' %}checked{% endif %}>
                        <input type="radio" name="Sex" value="女" title="女" {% if patient.Sex == '女' %}checked{% endif %}> 
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">电话</label>
                    <div class="layui-input-block">
                        <input type="text" name="ContactPhone" value="{{ patient.ContactPhone }}" lay-verify="mobile" autocomplete="off" placeholder="请输入电话号码" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">证件号</label>
                    <div class="layui-input-block">
                        <input type="text" name="IdNumber" value="{{ patient.IdNumber }}" lay-verify="number" autocomplete="off" placeholder="请输入证件号" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">生日</label>
                    <div class="layui-input-block">
                        <input type="text" name="Birthday" value="{{ patient.Birthday }}"  id="laydate-type-date" lay-verify="title" autocomplete="off" placeholder="请输入生日" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">地址</label>
                    <div class="layui-input-block">
                        <input type="text" name="Address" value="{{ patient.Address }}" lay-verify="title" autocomplete="off" placeholder="请输入地址" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">职业</label>
                    <div class="layui-input-block">
                        <input type="text" name="Career" value="{{ patient.Career }}" lay-verify="title" autocomplete="off" placeholder="请输入职业" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">民族</label>
                    <div class="layui-input-block">
                        <input type="text" name="Nation" value="{{ patient.Nation }}" lay-verify="title" autocomplete="off" placeholder="请输入民族" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">推荐人</label>
                    <div class="layui-input-block">
                        <input type="text" name="CustomerType" value="{{ patient.CustomerType }}" lay-verify="title" autocomplete="off" placeholder="请输入推荐人" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-block">
                        <input type="text" name="Remarks" value="{{ patient.Remarks }}" lay-verify="title" autocomplete="off" placeholder="请输入备注" class="layui-input">
                    </div>
                </div> 
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="pear-btn pear-btn-primary pear-btn-sm" id="patient-detail-submit">保 存</button>
                    </div>
                </div>
            </form>
          </div>
        </div>
        <!-- 诊断信息 -->
        <div class="layui-colla-item">
            <div class="layui-colla-title" style="background: #1e9fff; color: #fff;"><b>诊断信息</b></div>
            <div class="layui-colla-content colls-show layui-show">
              <div style="padding: 10px;">
                  <!-- 诊断信息表单 -->
                  <form class="layui-form" id="diagnostic-form" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                      <div class="layui-form-item layui-hide">
                          <label class="layui-form-label">DiagnosticID</label>
                          <div class="layui-input-block">
                              <input type="text" name="DiagnosticID" value="{{ diagnostics.DiagnosticID if diagnostics else '' }}" id="diagnostic-id" class="layui-input">
                          </div>
                      </div>
                      
                      <div class="layui-form-item">
                          <label class="layui-form-label">诊断</label>
                          <div class="layui-input-block">
                              <input type="text" id="diagnostic-diagnosis-input" placeholder="输入诊断标签后按回车添加" class="layui-input">
                              <div class="diagnosis-tags" id="diagnostic-diagnosis-tags" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div>
                          </div>
                      </div>

                      
                      <div class="layui-form-item">
                          <label class="layui-form-label">其他医院诊断</label>
                          <div class="layui-input-block">
                              <textarea name="OtherHospitalDiagnosis" id="diagnostic-other-hospital-diagnosis" placeholder="请输入其他医院诊断" class="layui-textarea" rows="2">{{ diagnostics.OtherHospitalDiagnosis if diagnostics else '' }}</textarea>
                          </div>
                      </div>
                      
                      <div class="layui-form-item">
                          <label class="layui-form-label">病理</label>
                          <div class="layui-input-block">
                              <textarea name="Pathology" id="diagnostic-pathology" placeholder="请输入病理描述" class="layui-textarea" rows="2">{{ diagnostics.Pathology if diagnostics else '' }}</textarea>
                          </div>
                      </div>
                      
                      <div class="layui-form-item">
                          <label class="layui-form-label">附件</label>
                          <div class="layui-input-block">
                              <button type="button" class="layui-btn layui-btn-sm" id="diagnostic-upload-attachments">
                                  <i class="layui-icon layui-icon-upload"></i>上传图片
                              </button>
                              <div class="attachments-preview" id="diagnostic-attachments-preview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;"></div>
                          </div>
                      </div>
                      
                      <div class="layui-form-item">
                          <label class="layui-form-label">备注</label>
                          <div class="layui-input-block">
                              <textarea name="Remarks" id="diagnostic-remarks" placeholder="请输入备注" class="layui-textarea" rows="2">{{ diagnostics.Remarks if diagnostics else '' }}</textarea>
                          </div>
                      </div>
                      
                      <div class="layui-form-item">
                          <div class="layui-input-block">
                              <button type="button" class="pear-btn pear-btn-primary pear-btn-sm" id="diagnostic-save-btn">保 存</button>
                          </div>
                      </div>
                  </form>
              </div>
            </div>
          </div>
        <!-- 患者病史 -->
        <div class="layui-colla-item">
          <div class="layui-colla-title" style="background: #1e9fff; color: #fff;"><b>患者病史</b></div>
          <div class="layui-colla-content colls-show layui-show">
            <div style="padding: 10px;">
                <!-- 添加病史表单 -->
                <form class="layui-form" id="history-form" style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <div class="layui-form-item layui-hide">
                        <label class="layui-form-label">HistoryID</label>
                        <div class="layui-input-block">
                            <input type="text" name="HistoryID" id="history-id" value="{{ histories.HistoryID if histories else '' }}" class="layui-input">
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">既往史</label>
                        <div class="layui-input-block">
                            <textarea name="PastHistory" id="history-pasthistory" placeholder="请输入既往史" class="layui-textarea" rows="1">{{ histories.PastHistory if histories else '' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">个人史</label>
                        <div class="layui-input-block">
                            <textarea name="PersonalHistory" id="history-personalhistory" placeholder="请输入个人史" class="layui-textarea" rows="1">{{ histories.PersonalHistory if histories else '' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">婚育史</label>
                        <div class="layui-input-block">
                            <textarea name="MarriageHistory" id="history-marriagehistory" placeholder="请输入婚育史" class="layui-textarea" rows="1">{{ histories.MarriageHistory if histories else '' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">家族史</label>
                        <div class="layui-input-block">
                            <textarea name="FamilyHistory" id="history-familyhistory" placeholder="请输入家族史" class="layui-textarea" rows="1">{{ histories.FamilyHistory if histories else '' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">过敏史</label>
                        <div class="layui-input-block">
                            <textarea name="AllergyHistory" id="history-allergyhistory" placeholder="请输入过敏史" class="layui-textarea" rows="1">{{ histories.AllergyHistory if histories else '' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">月经史</label>
                        <div class="layui-input-block">
                            <textarea name="MenstrualHistory" id="history-menstrualhistory" placeholder="请输入月经史" class="layui-textarea" rows="1">{{ histories.MenstrualHistory if histories else '' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">其它</label>
                        <div class="layui-input-block">
                            <textarea name="Other" id="history-other" placeholder="请输入其它" class="layui-textarea" rows="1">{{ histories.Other if histories else '' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <label class="layui-form-label">小结</label>
                        <div class="layui-input-block">
                            <textarea name="Summary" id="history-summary" placeholder="请输入小结" class="layui-textarea" rows="2">{{ histories.Summary if histories else '' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button type="button" class="pear-btn pear-btn-primary pear-btn-sm" id="history-save-btn">保 存</button>
                        </div>
                    </div>
                </form>
                
            </div>
          </div>
        </div>
        <!-- 辅助检查 -->
        <div class="layui-colla-item">
          <div class="layui-colla-title" style="background: #1e9fff; color: #fff;">
            <span class="layui-col-xs11 "><b>辅助检查</b></span>
            <span class="layui-col-xs1 pull-right">
                <button class="pear-btn layui-bg-blue" id="add-exam" style="border-color: #1e9fff;" onclick="window.addExam()">
                    <i class="pear-icon pear-icon-add"></i>
                    新增
                </button>
            </span>
          </div>
          <div class="layui-colla-content colls-show layui-show">
            <div id="examinations-list">
                {% if examlib and examlib|length > 0 %}
                <div class="layui-collapse">
                    {% for examlib in examlib %}
                    <!-- 辅助检查列表 -->
                    <div class="layui-colla-item">
                        <div class="layui-colla-title layui-colla-title-text">
                            <span class="layui-col-xs1"><strong>{{ examlib.ExamName or '' }}</strong></span>
                            <span class="layui-col-xs3">时间：{{ examlib.CreateDate or '' }}</span>
                            <span class="layui-col-xs7">医生：{{ examlib.Creator or '' }}</span>
                            <span class="layui-col-xs1 pull-right">
                                <button class="pear-btn edit-exam-btn" style="border: none;" data-exam-id="{{ examlib.ExamID }}" data-patient-id="{{ patient.PatientID if patient else '' }}">
                                    <i class="pear-icon pear-icon-edit"></i> 编辑
                                </button>
                            </span>
                        </div>
                        <div class="layui-colla-content layui-show" style="padding: 20px;">
                            <div class="list-item" style="border-bottom: none;">
                                <div style="margin-bottom: 10px;">
                                    <strong>检查结果：</strong>
                                    <div style="margin-top: 5px;">{{ examlib.Remarks or '' }}</div>
                                </div>
                            </div>
                            <div class="list-item" style="border-bottom: none;">
                                <div style="margin-bottom: 10px;">
                                    <strong>附件：</strong>
                                    {% set exam_attachments = examlib.get_attachments_list() if examlib.AttachMents else [] %}
                                    {% if exam_attachments and exam_attachments|length > 0 %}
                                        <div class="attachments-preview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                            {% for attachment in exam_attachments %}
                                                <div class="attachment-item" style="position: relative; width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                                    <img src="{{ attachment }}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="previewExamImage('{{ attachment }}')">
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <span style="color: #999; font-size: 12px;">共 {{ exam_attachments|length }} 张图片</span>
                                    {% else %}
                                        <span style="color: #999;">暂无附件</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-tip">暂无检查报告</div>
                {% endif %}
            </div>
          </div>
        </div>
        <!-- 病程记录 -->
        <div class="layui-colla-item">
          <div class="layui-colla-title" style="background: #1e9fff; color: #fff;">
            <span class="layui-col-xs11 "><b>病程记录</b></span>
            <span class="layui-col-xs1 pull-right">
                <button class="pear-btn layui-bg-blue" id="add-course" style="border-color: #1e9fff;" onclick="window.addCourse()">
                    <i class="pear-icon pear-icon-add"></i>
                    新增
                </button>
            </span>
          </div>
          <div class="layui-colla-content colls-show layui-show">
            <div id="courses-list">
                {% if courses and courses|length > 0 %}
                <div class="layui-collapse">
                    {% for course in courses %}
                    <!-- 病程列表 -->
                    <div class="layui-colla-item">
                        <div class="layui-colla-title layui-colla-title-text">
                            <span class="layui-col-xs1"><strong>{{ course.CourseType or '' }}</strong></span>
                            <span class="layui-col-xs3">时间：{{ course.CourseTime or '' }}</span>
                            <span class="layui-col-xs7">医生：{{ course.Creator or '' }}</span>
                            <span class="layui-col-xs1 pull-right">
                                <button class="pear-btn edit-course-btn" style="border: none;" data-course-id="{{ course.CourseID }}" data-patient-id="{{ patient.PatientID if patient else '' }}">
                                    <i class="pear-icon pear-icon-edit"></i> 编辑
                                </button>
                            </span>
                        </div>
                        <!-- 病程记录内容 -->
                        <div class="layui-colla-content layui-show" style="padding: 20px;">
                            <div class="list-item" style="border-bottom: none;">
                                <div style="margin-bottom: 10px;">
                                    <strong>现病史：</strong>{{ course.CurrentDisease or '' }}
                                </div>
                            </div>
                            <div class="list-item" style="border-bottom: none;">
                                <div style="margin-bottom: 10px;">
                                    <strong>治疗方案：</strong>
                                    <div style="margin-top: 5px;">{{ course.TreatmentPlan or '' }}</div>
                                </div>
                            </div>
                            <div class="list-item" style="border-bottom: none;">
                                <div style="margin-bottom: 10px;">
                                    <strong>附件：</strong>
                                    {% set course_attachments = course.get_attachments_list() if course.AttachMents else [] %}
                                    {% if course_attachments and course_attachments|length > 0 %}
                                        <div class="attachments-preview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                            {% for attachment in course_attachments %}
                                                <div class="attachment-item" style="position: relative; width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                                    <img src="{{ attachment }}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="previewCourseImage('{{ attachment }}')">
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <span style="color: #999; font-size: 12px;">共 {{ course_attachments|length }} 张图片</span>
                                    {% else %}
                                        <span style="color: #999;">暂无附件</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-tip">暂无病程记录</div>
                {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% include 'system/common/footer.html' %}
    <script>
        layui.use(['element', 'form', 'jquery', 'layer', 'laydate', 'upload'], function () {
            let element = layui.element
            let form = layui.form
            let $ = layui.jquery
            let layer = layui.layer
            let laydate = layui.laydate
            let upload = layui.upload

            // 折叠面板点击事件
            element.on('collapse(filter-collapse)', function(data){

                // console.log(data.show); // 得到当前面板的展开状态，true or false
                // console.log(data.title); // 得到当前点击面板的标题区域对象
                // console.log(data.content); // 得到当前点击面板的内容区域对象
                // // 显示状态，仅用于演示
                // layer.msg('展开状态：'+ data.show);
            });

            // 收缩所有折叠面板
            $('#collapse-all-btn').on('click', function() {
                const texts = $(this).text() == '展开所有' ? '收缩所有' : '展开所有'
                $(this).text(texts)

                const $content = $('.colls-show').each(function() {
                    if (texts == '展开所有') {
                        $(this).removeClass('layui-show')
                    } else {
                        $(this).addClass('layui-show')
                    }
                })
            })

            // 从URL获取PatientID
            function getUrlParam(name) {
                const urlParams = new URLSearchParams(window.location.search)
                return urlParams.get(name) || window.location.pathname.split('/').pop()
            }

            const PatientID = getUrlParam('PatientID') || '{{ patient.PatientID if patient else "" }}'
            if (!PatientID) {
                layer.msg('缺少患者ID', {icon: 2})
                return
            }

            // 初始化日期选择器
            laydate.render({
                elem: '#laydate-type-date',
                type: 'date',
                format: 'yyyy-MM-dd'
            });

            // 提交按钮点击事件 - 保存患者信息
            $('#patient-detail-submit').on('click', function(e) {
                e.preventDefault() // 阻止默认行为，防止表单提交导致页面刷新
                
                // 收集表单数据
                const formData = {
                    PatientID: $('input[name="PatientID"]').val(),
                    PatientNo: $('input[name="PatientNo"]').val(),
                    Name: $('input[name="Name"]').val(),
                    Sex: $('input[name="Sex"]:checked').val(),
                    ContactPhone: $('input[name="ContactPhone"]').val(),
                    IdNumber: $('input[name="IdNumber"]').val(),
                    Birthday: $('input[name="Birthday"]').val(),
                    Address: $('input[name="Address"]').val(),
                    Career: $('input[name="Career"]').val(),
                    Nation: $('input[name="Nation"]').val(),
                    CustomerType: $('input[name="CustomerType"]').val(),
                    Remarks: $('input[name="Remarks"]').val()
                }

                // 验证必填字段
                if (!formData.Name || !formData.PatientNo || !formData.Sex || !formData.Nation) {
                    layer.msg('患者姓名、患者编号、性别、民族不得为空', {icon: 2})
                    return false
                }

                // 发送 AJAX 请求保存数据
                $.ajax({
                    url: '/system/patients/update',
                    type: 'put',
                    data: JSON.stringify(formData),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (result) {
                        if (result.success) {
                            layer.msg(result.msg || '保存成功', {icon: 1})
                        } else {
                            layer.msg(result.msg || '保存失败', {icon: 2})
                        }
                    },
                    error: function (xhr, status, error) {
                        layer.msg('保存失败，请稍后重试', {icon: 2})
                        console.error('保存失败:', error)
                    }
                })
                
                return false // 确保不触发表单提交
            })

            // ========== 患者病史相关功能 ==========
                        
            // 保存病史按钮点击事件
            $('#history-save-btn').on('click', function(e) {
                e.preventDefault()
                
                const HistoryID = $('#history-id').val()
                
                const formData = {
                    PatientID: PatientID,
                    PastHistory: $('#history-pasthistory').val(),
                    PersonalHistory: $('#history-personalhistory').val(),
                    MarriageHistory: $('#history-marriagehistory').val(),
                    FamilyHistory: $('#history-familyhistory').val(),
                    AllergyHistory: $('#history-allergyhistory').val(),
                    MenstrualHistory: $('#history-menstrualhistory').val(),
                    Other: $('#history-other').val(),
                    Summary: $('#history-summary').val()
                }
                
                // 根据是否有 HistoryID 确定请求 URL 和方法
                const url = HistoryID ? '/system/patientmedicalhistories/update' : '/system/patientmedicalhistories/save'
                const method = HistoryID ? 'put' : 'post'
                
                if (HistoryID) {
                    formData.HistoryID = HistoryID
                }
                
                // 发送 AJAX 请求保存数据
                $.ajax({
                    url: url,
                    type: method,
                    data: JSON.stringify(formData),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (result) {
                        if (result.success) {
                            layer.msg(result.msg || '保存成功', {icon: 1})
                        } else {
                            layer.msg(result.msg || '保存失败', {icon: 2})
                        }
                    },
                    error: function (xhr, status, error) {
                        layer.msg('保存失败，请稍后重试', {icon: 2})
                        console.error('保存失败:', error)
                    }
                })
                
                return false
            })

            // ========== 诊断信息相关功能 ==========
            
            // 诊断标签管理
            let diagnosticDiagnosisList = []
            
            // 初始化诊断标签（从后端数据加载）
            {% if diagnostics and diagnostics.Diagnosis %}
                {% set diagnosis_list = diagnostics.get_diagnosis_list() %}
                {% if diagnosis_list %}
                    try {
                        var diagnosisData = {{ diagnosis_list|tojson|safe }};
                        if (Array.isArray(diagnosisData)) {
                            diagnosticDiagnosisList = diagnosisData
                        }
                    } catch(e) {
                        console.error('解析诊断标签失败:', e)
                    }
                {% endif %}
            {% endif %}
            // 初始化渲染标签
            renderDiagnosticDiagnosisTags()
            
            $('#diagnostic-diagnosis-input').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault()
                    let tag = $(this).val().trim()
                    if (tag && diagnosticDiagnosisList.indexOf(tag) === -1) {
                        diagnosticDiagnosisList.push(tag)
                        renderDiagnosticDiagnosisTags()
                        $(this).val('')
                    }
                }
            })
            
            function renderDiagnosticDiagnosisTags() {
                let html = ''
                if (diagnosticDiagnosisList.length === 0) {
                    html = '<span style="color: #999;">暂无</span>'
                } else {
                    diagnosticDiagnosisList.forEach(function(tag, index) {
                        html += '<span class="diagnosis-tag">' + tag + 
                               '<span class="tag-close" data-index="' + index + '">×</span></span>'
                    })
                }
                $('#diagnostic-diagnosis-tags').html(html)
            }
            
            $(document).on('click', '#diagnostic-diagnosis-tags .tag-close', function() {
                let index = $(this).data('index')
                diagnosticDiagnosisList.splice(index, 1)
                renderDiagnosticDiagnosisTags()
            })
            
            // ============== 附件管理 ==============
            
            let diagnosticAttachmentsList = []
            
            // 初始化已有附件（从后端数据加载）
            {% if diagnostics and diagnostics.AttachMents %}
                {% set attachments_list = diagnostics.get_attachments_list() %}
                {% if attachments_list %}
                    try {
                        var attachmentsData = {{ attachments_list|tojson|safe }};
                        if (Array.isArray(attachmentsData)) {
                            diagnosticAttachmentsList = attachmentsData
                        }
                    } catch(e) {
                        console.error('解析附件列表失败:', e)
                    }
                {% endif %}
            {% endif %}
            
            // 初始化渲染附件
            renderDiagnosticAttachments()
            
            upload.render({
                elem: '#diagnostic-upload-attachments',
                url: "{{ url_for('system.adminFile.upload_api') }}",
                accept: 'images',
                multiple: true,
                done: function(res) {
                    if (res.success && res.data && res.data.src) {
                        diagnosticAttachmentsList.push(res.data.src)
                        renderDiagnosticAttachments()
                    } else {
                        layer.msg(res.msg || '上传失败', {icon: 2})
                    }
                },
                error: function() {
                    layer.msg('上传失败，请稍后重试', {icon: 2})
                }
            })
            
            function renderDiagnosticAttachments() {
                let html = ''
                if (diagnosticAttachmentsList.length === 0) {
                    html = '<span style="color: #999;">暂无附件</span>'
                } else {
                    diagnosticAttachmentsList.forEach(function(url, index) {
                        html += '<div class="attachment-item">' +
                               '<img src="' + url + '" onclick="previewDiagnosticImage(\'' + url + '\')">' +
                               '<button type="button" class="delete-btn" data-index="' + index + '" title="删除">×</button>' +
                               '</div>'
                    })
                }
                $('#diagnostic-attachments-preview').html(html)
            }
            
            $(document).on('click', '#diagnostic-attachments-preview .delete-btn', function(e) {
                e.stopPropagation()
                let index = $(this).data('index')
                layer.confirm('确定要删除这张图片吗？', {
                    icon: 3,
                    title: '提示'
                }, function(confirmIndex) {
                    diagnosticAttachmentsList.splice(index, 1)
                    renderDiagnosticAttachments()
                    layer.close(confirmIndex)
                })
            })
            
            // 图片预览 - 在顶级父窗口预览（通用函数）
            function previewImageInTopWindow(url) {
                // 检查是否在iframe中，如果是则在顶级父窗口预览，否则在当前窗口预览
                if (window.top && window.top !== window && window.top.layui) {
                    // 在顶级父窗口中使用layer打开预览
                    window.top.layui.use('layer', function() {
                        window.top.layui.layer.open({
                            type: 1,
                            title: false,
                            closeBtn: 1,
                            area: ['90%', '90%'],
                            shadeClose: true,
                            content: '<img src="' + url + '" style="width: 100%; height: 100%; object-fit: contain;">'
                        })
                    })
                } else {
                    // 不在iframe中或顶级父窗口没有layui，在当前窗口预览
                    layer.open({
                        type: 1,
                        title: false,
                        closeBtn: 1,
                        area: ['90%', '90%'],
                        shadeClose: true,
                        content: '<img src="' + url + '" style="width: 100%; height: 100%; object-fit: contain;">'
                    })
                }
            }
            
            // 诊断信息图片预览
            window.previewDiagnosticImage = function(url) {
                previewImageInTopWindow(url)
            }
            
            // 病程记录图片预览
            window.previewCourseImage = function(url) {
                previewImageInTopWindow(url)
            }
            
            // 辅助检查图片预览
            window.previewExamImage = function(url) {
                previewImageInTopWindow(url)
            }
            
            // 保存诊断信息按钮点击事件
            $('#diagnostic-save-btn').on('click', function(e) {
                e.preventDefault()
                
                const DiagnosticID = $('#diagnostic-id').val()
                const formData = {
                    PatientID: PatientID,
                    Diagnosis: diagnosticDiagnosisList,
                    OtherHospitalDiagnosis: $('#diagnostic-other-hospital-diagnosis').val(),
                    Pathology: $('#diagnostic-pathology').val(),
                    AttachMents: diagnosticAttachmentsList,
                    Remarks: $('#diagnostic-remarks').val()
                }
                
                if (DiagnosticID) {
                    formData.DiagnosticID = DiagnosticID
                }
                
                const url = DiagnosticID ? '/system/diagnostic/update' : '/system/diagnostic/save'
                const method = DiagnosticID ? 'put' : 'post'
                
                $.ajax({
                    url: url,
                    type: method,
                    data: JSON.stringify(formData),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (result) {
                        if (result.success) {
                            // 如果是新增操作，更新 DiagnosticID
                            if (!DiagnosticID && result.data && result.data.DiagnosticID) {
                                $('#diagnostic-id').val(result.data.DiagnosticID)
                            }
                            layer.msg(result.msg || '保存成功', {icon: 1})
                        } else {
                            layer.msg(result.msg || '保存失败', {icon: 2})
                        }
                    },
                    error: function (xhr, status, error) {
                        layer.msg('保存失败，请稍后重试', {icon: 2})
                        console.error('保存失败:', error)
                    }
                })
                
                return false
            })
            
            // 新增病程记录
            window.addCourse = function() {
                if (!PatientID) {
                    layer.msg('缺少患者ID', {icon: 2})
                    return
                }
                // 检查是否在iframe中，如果是则在顶级父窗口打开，否则在当前窗口打开
                if (window.top && window.top !== window && window.top.layui) {
                    window.top.layui.use('layer', function() {
                        window.top.layui.layer.open({
                            type: 2,
                            title: '新增病程',
                            shade: 0.1,
                            area: ['900px', '700px'],
                            content: "{{ url_for('system.coursesofdisease.add') }}?PatientID=" + PatientID
                        })
                    })
                } else {
                    layer.open({
                        type: 2,
                        title: '新增病程',
                        shade: 0.1,
                        area: ['900px', '700px'],
                        content: "{{ url_for('system.coursesofdisease.add') }}?PatientID=" + PatientID
                    })
                }
            }
            
            // 编辑病程记录
            window.editCourse = function(CourseID, patientIdParam) {
                if (!CourseID) {
                    layer.msg('缺少病程ID', {icon: 2})
                    return
                }
                // 如果没有传递 patientIdParam，使用全局的 PatientID
                const finalPatientID = patientIdParam || PatientID
                // 构建编辑页面URL
                const editUrl = "{{ url_for('system.coursesofdisease.main') }}/edit/" + CourseID + (finalPatientID ? "?PatientID=" + finalPatientID : "")
                // 检查是否在iframe中，如果是则在顶级父窗口打开，否则在当前窗口打开
                // 默认状态打开顶级弹出层
                if (window.top && window.top !== window && window.top.layui) {
                    window.top.layui.use('layer', function() {
                        window.top.layui.layer.open({
                            type: 2,
                            title: '编辑病程',
                            shade: 0.1,
                            area: ['900px', '700px'],
                            content: editUrl
                        })
                    })
                } else {
                    layer.open({
                        type: 2,
                        title: '编辑病程',
                        shade: 0.1,
                        area: ['900px', '700px'],
                        content: editUrl
                    })
                }
            }
            
            // 绑定编辑按钮点击事件
            $(document).on('click', '.edit-course-btn', function() {
                const courseID = $(this).data('course-id')
                const patientID = $(this).data('patient-id') || PatientID
                window.editCourse(courseID, patientID)
            })
            
            // 新增检查项目
            window.addExam = function() {
                if (!PatientID) {
                    layer.msg('缺少患者ID', {icon: 2})
                    return
                }
                // 检查是否在iframe中，如果是则在顶级父窗口打开，否则在当前窗口打开
                if (window.top && window.top !== window && window.top.layui) {
                    window.top.layui.use('layer', function() {
                        window.top.layui.layer.open({
                            type: 2,
                            title: '新增检查项目',
                            shade: 0.1,
                            area: ['800px', '600px'],
                            content: "{{ url_for('system.examlib.add') }}?PatientID=" + PatientID
                        })
                    })
                } else {
                    layer.open({
                        type: 2,
                        title: '新增检查项目',
                        shade: 0.1,
                        area: ['800px', '600px'],
                        content: "{{ url_for('system.examlib.add') }}?PatientID=" + PatientID
                    })
                }
            }
            
            // 编辑辅助检查
            window.editExam = function(ExamID, patientIdParam) {
                if (!ExamID) {
                    layer.msg('缺少检查ID', {icon: 2})
                    return
                }
                // 如果没有传递 patientIdParam，使用全局的 PatientID
                const finalPatientID = patientIdParam || PatientID
                // 构建编辑页面URL - 使用基础路径拼接
                const baseUrl = "{{ url_for('system.examlib.main') }}"
                const editUrl = baseUrl.replace(/\/$/, '') + '/edit/' + ExamID + (finalPatientID ? "?PatientID=" + finalPatientID : "")
                // 检查是否在iframe中，如果是则在顶级父窗口打开，否则在当前窗口打开
                if (window.top && window.top !== window && window.top.layui) {
                    window.top.layui.use('layer', function() {
                        window.top.layui.layer.open({
                            type: 2,
                            title: '编辑检查项目',
                            shade: 0.1,
                            area: ['800px', '600px'],
                            content: editUrl
                        })
                    })
                } else {
                    layer.open({
                        type: 2,
                        title: '编辑检查项目',
                        shade: 0.1,
                        area: ['800px', '600px'],
                        content: editUrl
                    })
                }
            }
            
            // 绑定编辑按钮点击事件
            $(document).on('click', '.edit-exam-btn', function() {
                const examID = $(this).data('exam-id')
                const patientID = $(this).data('patient-id') || PatientID
                window.editExam(examID, patientID)
            })
            
    })
</script>
</body>
</html>