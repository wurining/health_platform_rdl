<!DOCTYPE html>
<html>
<head>
    <title>预约管理</title>
    {% include 'system/common/header.html' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='system/admin/css/other/user.css') }}"/>
    <style>
        .appointment-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            padding: 20px;
        }
        .appointment-card {
            background: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }
        .appointment-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .appointment-card.past {
            opacity: 0.6;
            background: #f5f5f5;
        }
        .appointment-card-header {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e6e6e6;
        }
        .appointment-card-body {
            margin-bottom: 10px;
        }
        .appointment-card-item {
            display: flex;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .appointment-card-label {
            color: #666;
            width: 80px;
            flex-shrink: 0;
        }
        .appointment-card-value {
            color: #333;
            flex: 1;
        }
        .appointment-card-footer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e6e6e6;
            display: flex;
            gap: 10px;
        }
        .appointment-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: #999;
        }
        @media (max-width: 1600px) {
            .appointment-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (max-width: 1200px) {
            .appointment-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 900px) {
            .appointment-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            .appointment-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="pear-container">
    <!-- 查询表单 -->
    <div class="layui-card">
        <div class="layui-card-body">
            <form class="layui-form" action="" lay-filter="user-query-form">
                <div class="layui-form-item">
                    <label class="layui-form-label">预约日期</label>
                    <div class="layui-input-inline">
                        <input type="text" name="AppointmentTime" id="laydate-type-date" placeholder="" class="layui-input" value="">
                    </div>
                    <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="user-query">
                        <i class="layui-icon layui-icon-search"></i>查询
                    </button>
                    <button type="reset" class="pear-btn pear-btn-md">
                        <i class="layui-icon layui-icon-refresh"></i>重置
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div class="user-left user-collasped">
        <div class="layui-card">
            <div class="layui-card-body">
                <div style="overflow: auto">
                    <div id="date_nav"></div>
                    <div id="date_content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户表格  -->
    <div class="user-main user-collasped">
        <div class="layui-card">
            <div class="layui-card-body">

                <div id="appointment-grid" class="appointment-grid">
                    <!-- 预约卡片将通过JavaScript动态生成 -->
                </div>
                <div id="appointment-pagination" class="layui-box layui-laypage layui-laypage-default"></div>
            </div>
        </div>
    </div>
</body>


<!-- 表格操作 -->
<script type="text/html" id="user-toolbar">
    {% if authorize("system:outpatients:add") %}
        <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add">
            <i class="pear-icon pear-icon-add"></i>新增
        </button>
    {% endif %}
    <button class="pear-btn pear-btn-md" lay-event="collasped">
        <i class="pear-icon pear-icon-modular"></i>日期
    </button>
</script>

<!-- 用户修改操作  -->
<script type="text/html" id="user-bar">
    {% if authorize("system:outpatients:edit") %}
        <button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="edit"><i class="pear-icon pear-icon-edit"> 修改预约时间</i>
        </button>
    {% endif %}
    {% if authorize("system:outpatients:remove") %}
        <button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="remove"><i
                class="pear-icon pear-icon-ashbin"> 取消预约</i>
        </button>
    {% endif %}
</script>

{% raw %}
<script type="text/html" id="user-enable">
    <input type="checkbox" name="enable" value="{{ d.id }}" lay-skin="switch" lay-text="启用|禁用"
           lay-filter="user-enable"
            {{# if(d.enable==1){ }} checked {{# } }} />
</script>

<script type="text/html" id="user-createTime">
    {{layui.util.toDateString(d.create_at,  "yyyy-MM-dd HH:mm:ss")}}
</script>

<script type="text/html" id="user-updateTime">
    {{layui.util.toDateString(d.update_at,  "yyyy-MM-dd HH:mm:ss")}}
</script>
{% endraw %}

{% include 'system/common/footer.html' %}

<script>
        
    layui.use(['form', 'jquery', 'popup', 'common', 'laypage'], function () {
        let form = layui.form
        let $ = layui.jquery
        let laydate = layui.laydate;
        let popup = layui.popup
        let common = layui.common
        let MODULE_PATH = "{{ url_for('system.outpatients.main') }}"
        // 权限标志
        let canEdit = {% if authorize("system:outpatients:edit") %}true{% else %}false{% endif %}
        let canRemove = {% if authorize("system:outpatients:remove") %}true{% else %}false{% endif %}

        // 获取今天的日期
        function getTodayDate() {
            let today = new Date();
            let year = today.getFullYear();
            let month = String(today.getMonth() + 1).padStart(2, '0');
            let day = String(today.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }
        
        // 设置输入框默认值为今天
        $('#laydate-type-date').val(getTodayDate());
        
        // 检索日期
        laydate.render({
            elem: '#laydate-type-date',
            format: 'yyyy-MM-dd',
            value: getTodayDate()
        });
        
        // 日期导航
        laydate.render({
            elem: '#date_nav',
            position: 'static',
            change: function(value, date) { 
                //监听日期被切换
                lay('#date_content').html(value);
            }
        });

        // 当前页码和每页数量
        let currentPage = 1
        let pageSize = 15
        
        // 渲染卡片网格数据
        function renderGrid(data, total) {
            let gridHtml = ''
            if (data && data.length > 0) {
                data.forEach(function(item) {
                    let pastClass = item.is_past ? 'past' : ''
                    gridHtml += `
                        <div class="appointment-card ${pastClass}" data-id="${item.AppointmentID}">
                            <div class="appointment-card-header">${item.Name || '未命名'}</div>
                            <div class="appointment-card-body">
                                <div class="appointment-card-item">
                                    <span class="appointment-card-label">患者编号：</span>
                                    <span class="appointment-card-value">${item.PatientNo || '-'}</span>
                                </div>
                                <div class="appointment-card-item">
                                    <span class="appointment-card-label">预约时间：</span>
                                    <span class="appointment-card-value">${item.AppointmentTime || '-'}</span>
                                </div>
                            </div>
                            <div class="appointment-card-footer">
                                ${canEdit ? `<button class="pear-btn pear-btn-primary pear-btn-sm" onclick="window.editCard('${item.AppointmentID}')">
                                    <i class="pear-icon pear-icon-edit"> 修改预约时间</i>
                                </button>` : ''}
                                ${canRemove ? `<button class="pear-btn pear-btn-danger pear-btn-sm" onclick="window.removeCard('${item.AppointmentID}')">
                                    <i class="pear-icon pear-icon-ashbin"> 取消预约</i>
                                </button>` : ''}
                            </div>
                        </div>
                    `
                })
            } else {
                gridHtml = '<div class="appointment-empty">暂无预约信息</div>'
            }
            $('#appointment-grid').html(gridHtml)
            
            // 渲染分页
            layui.laypage.render({
                elem: 'appointment-pagination',
                count: total,
                limit: pageSize,
                curr: currentPage,
                layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip'],
                limits: [15, 30, 45, 60],
                jump: function(obj, first) {
                    if (!first) {
                        currentPage = obj.curr
                        pageSize = obj.limit
                        loadData()
                    }
                }
            })
        }
        
        // 加载数据
        function loadData(param) {
            let loading = layer.load()
            let queryParams = param || {}
            queryParams.page = currentPage
            queryParams.limit = pageSize
            
            $.ajax({
                url: MODULE_PATH + 'data',
                type: 'GET',
                data: queryParams,
                dataType: 'json',
                success: function(result) {
                    layer.close(loading)
                    if (result.code === 0) {
                        renderGrid(result.data, result.count)
                    } else {
                        popup.failure(result.msg || '加载数据失败')
                    }
                },
                error: function() {
                    layer.close(loading)
                    popup.failure('网络错误，请稍后重试')
                }
            })
        }
        
        // 初始加载数据
        loadData()

        //
        $('.user-group').click(function () {
            let group = $(this).attr('user-group')
            let field = form.val('user-query-form')
            if (group === '-1') {
                field.deptId = group
                $(this).removeClass('button-default')
                $(this).prev().removeClass('button-primary')
                $(this).prev().addClass('button-default')
                $(this).addClass('button-primary')
            } else {
                field.deptId = group
                $(this).removeClass('button-default')
                $(this).next().removeClass('button-primary')
                $(this).next().addClass('button-default')
                $(this).addClass('button-primary')
            }
            window.refresh(field)
        })

        // 工具栏按钮事件
        $('#btn-add').on('click', function() {
            window.add()
        })
        
        $('#btn-collasped').on('click', function() {
            $('.user-left').toggleClass('user-collasped')
            $('.user-main').toggleClass('user-collasped')
        })

        form.on('submit(user-query)', function (data) {
            window.refresh(data.field)
            return false
        })

        window.add = function () {
            layer.open({
                type: 2,
                title: '新增',
                shade: 0.1,
                area: ['550px', '400px'],
                content: MODULE_PATH + 'add',
                end: function() {
                    loadData()
                }
            })
        }

        window.edit = function () {
            layer.open({
                type: 2,
                title: '新增',
                shade: 0.1,
                area: ['550px', '400px'],
                content: MODULE_PATH + 'add',
                end: function() {
                    loadData()
                }
            })
        }
        
        window.editCard = function (id) {
            layer.open({
                type: 2,
                title: '修改',
                shade: 0.1,
                area: ['550px', '400px'],
                content: MODULE_PATH + 'edit/' + id,
                end: function() {
                    loadData()
                }
            })
        }

        window.remove = function (obj) {
            layer.confirm('确定要取消该预约吗？', {icon: 3, title: '提示'}, function (index) {
                layer.close(index)
                let loading = layer.load()
                $.ajax({
                    url: MODULE_PATH + 'remove/' + obj.data['AppointmentID'],
                    dataType: 'json',
                    type: 'delete',
                    success: function (result) {
                        layer.close(loading)
                        if (result.success) {
                            popup.success(result.msg, function () {
                                loadData()
                            })
                        } else {
                            popup.failure(result.msg)
                        }
                    }
                })
            })
        }
        
        window.removeCard = function (id) {
            layer.confirm('确定要取消该预约吗？', {icon: 3, title: '提示'}, function (index) {
                layer.close(index)
                let loading = layer.load()
                $.ajax({
                    url: MODULE_PATH + 'remove/' + id,
                    dataType: 'json',
                    type: 'delete',
                    success: function (result) {
                        layer.close(loading)
                        if (result.success) {
                            popup.success(result.msg, function () {
                                loadData()
                            })
                        } else {
                            popup.failure(result.msg)
                        }
                    }
                })
            })
        }

        window.refresh = function (param) {
            currentPage = 1
            loadData(param)
        }
    })
</script>
</html>